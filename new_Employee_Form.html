<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        
        #name1,#email1,#phoneNumber1,#dob1,#year1,#salary1,#photo1{
            margin: 0px;
            text-align: left;
            margin-left: 5px;
            margin-top: 10px;
            margin-bottom: 0px;
            width: 100%;
            font-size: 17px;
        }
        #name,#email,#mobile,#dob,#yoj,#salary{
            width: 95%;
            margin-top: 10px;
            border-radius: 2px solid gray;
            height: 20px;
            padding:10px;
            border: 2px offset gray;
            border-radius: 5px;
            background-color: lightgray;
            font-size: 17px;
        }
        #nameError,#emailError,#mobileError,#dobError,#yojError,#salaryError,#photoError{
            margin: 0px;
            color: red;
            text-align: left;
            margin-top: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <script>
        
document.body.style.fontFamily = "Arial";
document.body.style.margin = "20px";

const title = document.createElement("h2");
title.innerText = "Form";
title.style.textAlign="center"
document.body.appendChild(title);

const form = document.createElement("form");
form.id = "employeeForm";
form.enctype = "multipart/form-data";
form.style.marginLeft= "25%";
form.style.marginRight= "25%";
form.style.borderWidth= "2px";
form.style.borderStyle = "solid";
form.style.borderColor="blue";
form.style.padding= "30px";
form.style.textAlign= "left";
form.style.borderRadius= "10px";
form.style.alignContent="center";
form.style.backgroundColor = "dodgerblue";
document.body.appendChild(form);

const name1 = document.createElement('label');
name1.textContent = "Name";
name1.id="name1";
name1.htmlFor = "name";
form.appendChild(name1);

const required = document.createElement("span");
required.textContent = " *";
required.style.color = "red";
required.style.width="100%";
form.appendChild(required)

const name = document.createElement('input');
name.setAttribute('type','text');
name.id='name';
form.appendChild(name);
const nameError = document.createElement('p');
nameError.id='nameError';
form.appendChild(nameError);

name.addEventListener("input", function(event){
    this.value=this.value.replace(/[^a-zA-Z ]/g,'')
    if(this.value.length >30){
        this.value = this.value.slice(0,30)
    }
})

const email1 = document.createElement('label');
email1.textContent = "Email";
email1.id="email1";
email1.htmlFor = "email";
email1.required=true;
form.appendChild(email1);
const required1 = document.createElement("span");
required1.textContent = " *";
required1.style.color = "red";
form.appendChild(required1)

const email = document.createElement('input');
email.setAttribute('type','text');
email.id='email';
form.appendChild(email);
const emailError = document.createElement('p');
emailError.id='emailError';
form.appendChild(emailError);

const mobile1 = document.createElement('label');
mobile1.textContent = "Mobile Number";
mobile1.id="mobile1";
mobile1.htmlFor = "mobile";
form.appendChild(mobile1);
const required2 = document.createElement("span");
required2.textContent = " *";
required2.style.color = "red";
required2.style.width="100%";
form.appendChild(required2)

const mobile = document.createElement('input')
mobile.setAttribute('type','text');
mobile.id='mobile'
form.appendChild(mobile);
const mobileError = document.createElement('p');
mobileError.id ='mobileError';
form.appendChild(mobileError);

mobile.addEventListener("input", function(event){
    this.value=this.value.replace(/[^0-9]/g,'')
    if(this.value.length > 10){
        this.value=this.value.slice(0,10);
    }
})

const dob1 = document.createElement('label');
dob1.textContent = "Date Of Birth";
dob1.id="dob1";
dob1.htmlFor = "dob";
form.appendChild(dob1);
const required3 = document.createElement("span");
required3.textContent = " *";
required3.style.color = "red";
required3.style.width="100%";
form.appendChild(required3)

const dob = document.createElement('input');
dob.setAttribute('type','date');
dob.id='dob';
form.appendChild(dob);
const dobError = document.createElement('p');
dobError.id='dobError';
form.appendChild(dobError);

const yoj1 = document.createElement('label');
yoj1.textContent = "Year Of Joining";
yoj1.id="yoj1";
yoj1.htmlFor = "yoj";
form.appendChild(yoj1);
const required4 = document.createElement("span");
required4.textContent = " *";
required4.style.color = "red";
required4.style.width="100%";
form.appendChild(required4)

const yoj = document.createElement('input');
yoj.setAttribute('type','text');
yoj.id='yoj';
form.appendChild(yoj);
const yojError = document.createElement('p');
yojError.id='yojError';
form.appendChild(yojError);

yoj.addEventListener("input", function(event){
    this.value=this.value.replace(/[^0-9]/g,'')
    if(this.value.length > 4){
        this.value = this.value.slice(0,4)
    }
})

const salary1 = document.createElement('label');
salary1.textContent = "Salary";
salary1.id="salary1";
salary1.htmlFor = "salary";
form.appendChild(salary1);
const required5 = document.createElement("span");
required5.textContent = " *";
required5.style.color = "red";
required5.style.width="100%";
form.appendChild(required5)

const salary = document.createElement('input');
salary.setAttribute('type','text');
salary.id='salary';
form.appendChild(salary);
const salaryError = document.createElement('p');
salaryError.id='salaryError';
form.appendChild(salaryError);

salary.addEventListener("input", function(event){
    this.value=this.value.replace(/[^0-9]/g,'')
})

const lblImg = document.createElement("label");
lblImg.innerText = "Profile Picture";
lblImg.style.width="100%";
lblImg.htmlFor = "profile";
form.appendChild(lblImg)
const required6 = document.createElement("span");
required6.textContent = " *";
required6.style.color = "red";
required6.style.width="100%";
form.appendChild(required6)
const breakTag = document.createElement("br");
const inputImg = document.createElement("input");
inputImg.type = "file";
inputImg.id = "profile";
inputImg.style.display="none";
const upload = document.createElement("label");
upload.htmlFor = "profile"
upload.innerText = "upload";
upload.style.display="block";
upload.style.borderWidth= "2px";
upload.style.borderRadius= "4px";
upload.style.borderStyle= "offset";
upload.style.borderColor= "gray";
upload.style.backgroundColor = "gray";
upload.style.width="20%";
upload.style.textAlign="center";
upload.style.marginTop="5px";
upload.style.padding="3px";
upload.style.fontSize = "17px"
form.appendChild(upload);
form.appendChild(inputImg);

const photoError = document.createElement('p');
photoError.id='photoError';
form.appendChild(photoError);

const fileName = document.createElement("p");
fileName.id = "fileName";
form.appendChild(fileName);

const previewImg = document.createElement("img");
previewImg.id = "preview";
previewImg.style.height = "50px";
previewImg.style.border = "1px solid gray";
previewImg.style.marginTop = "5px";
previewImg.style.display = "none";
form.appendChild(previewImg);

let previousFile = null;
profile.addEventListener("change", function () {
    const file = this.files[0];
    const fileNameDisplay = document.getElementById("fileName");
    fileNameDisplay.textContent = this.value.split("\\").pop();
    if (file) {
        const reader = new FileReader();
        reader.onload = function () {
            previewImg.src = reader.result;
            previewImg.style.display = "block";
            previousFile = file;
        };
        reader.readAsDataURL(file);
        
    }
    else{
        clearImagePreview();
    }
});
function clearImagePreview(){
    previewImg.style.display="none";
    inputImg.value = "";
    previousFile = null;
    fileName.textContent="";
}

const btn = document.createElement("button");
btn.innerText = "Save";
btn.type = "submit";
btn.style.width = "20%";
btn.style.textAlign="center"
btn.style.gridColumn = "span 2";
btn.style.marginLeft = "57%";
btn.style.paddingTop = "1%";
btn.style.paddingBottom = "1%";
btn.style.borderWidth = "2px";
btn.style.borderRadius = "5px";
btn.style.borderStyle = "offset";
btn.style.borderColor = "gray";
btn.style.backgroundColor = "green";
btn.style.fontSize = "17px";
btn.style.color = "white";
btn.style.cursor = "pointer";
form.appendChild(btn);


const listBtn = document.createElement("button");
listBtn.innerText = "List";
listBtn.type = "button";
listBtn.id="listBtn";
listBtn.style.width = "20%";
listBtn.style.textAlign="center"
listBtn.style.gridColumn = "span 2";
listBtn.style.marginLeft = "10px";
listBtn.style.paddingTop = "1%";
listBtn.style.paddingBottom = "1%";
listBtn.style.borderWidth = "2px";
listBtn.style.borderRadius = "5px";
listBtn.style.borderStyle = "offset";
listBtn.style.borderColor = "gray";
listBtn.style.backgroundColor = "green";
listBtn.style.fontSize = "17px";
listBtn.style.color = "white";
listBtn.style.cursor = "pointer";
form.appendChild(listBtn);

listBtn.addEventListener("click", function(){
    window.location.href="list.html"
})

let editIndex = localStorage.getItem("editIndex");

if (editIndex !== null) {
    editIndex = Number(editIndex);
    const employees = JSON.parse(localStorage.getItem("employees") || "[]");
    const emp = employees[editIndex];

    document.getElementById("name").value = emp.name;
    document.getElementById("email").value = emp.email;
    document.getElementById("mobile").value = emp.mobile;
    document.getElementById("dob").value = emp.dob;
    document.getElementById("yoj").value = emp.yoj;
    document.getElementById("salary").value = emp.salary;
    if(emp.profile){
        previewImg.src=emp.profile;
        previewImg.style.display="block";
        fileName.textContent="Existing image";
    }

    btn.innerText = "Update";
}
function saveEmployees(data) {
    localStorage.setItem("employees", JSON.stringify(data));
}
function getEmployees() {
    return JSON.parse(localStorage.getItem("employees") || "[]");
}

function resetForm() {
    form.reset();
    fileName.textContent="";
    localStorage.removeItem("editIndex");
    editIndex = null;
    btn.innerText = "Save";
}

function validateForm(name, email, mobile, dob, yoj, salary, profileFile) {
    const currentYear = new Date().getFullYear();
    let employees = getEmployees()
    const duplicateEmail = employees.some((e, i) => e.email === email && i !== editIndex);
    const duplicateMobile = employees.some((e, i) => e.mobile === mobile && i !== editIndex);
    let valid = true;
    if(!name){
        nameError.innerText = "Name is required.";
        valid = false;
    }else if (name.length < 3) {
        nameError.innerText = "Name must be at least 3 letters.";
        valid = false;
    }else{
        nameError.innerText = "";
    }
    if (!email) {
        emailError.innerText = "Email is required.";
        valid = false;
    }else if (!email.match(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/)) {
        emailError.innerText = "Invalid email format.";
        valid = false;
    }else if (duplicateEmail) {
        emailError.innerText = "Email already exists.";
        return;
    } else {
        emailError.innerText = "";
    }
    if (!mobile) {
        mobileError.innerText = "Mobile is required.";
        valid = false;
    }else if (!mobile.match(/^[0-9]{10}$/)) {
        mobileError.innerText = "Mobile must be exactly 10 digits.";
        valid = false;
    }else if (duplicateMobile) {
        mobileError.innerText = "Mobile number already exists.";
        return;
    } else {
        mobileError.innerText = "";
    }

    if (!dob) {
        dobError.innerText = "Date Of Birth is required";
        valid = false;
    }else{
        dobError.innerText = "";
    }

    if (!yoj) {
        yojError.innerText = "Year is required.";
        valid = false;
    }else if (yoj < 1990 || yoj > currentYear) {
        yojError.innerText = `"Year of joining must be between 1990 and ${currentYear}."`;
        valid = false;
    }else{
        yojError.innerText = "";
    }

    if (!salary) {
        salaryError.innerText = "Salary is required.";
        valid = false;
    }else{
        salaryError.innerText = "";
    }

    if (!profileFile && editIndex === null) {
        photoError.innerText = "Please upload a profile picture.";
        valid = false;
    }else{
        photoError.innerText = "";
    }

    return valid;
}

function compressImage(file, maxWidth = 200, maxHeight = 200, quality = 0.7,callback){
    const reader = new FileReader();
    reader.onload = function (event){
        const img = new Image();
        img.onload = function(){
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;
            if(width>maxWidth){
                height *=maxWidth / width;
                width = maxWidth;
            }
            if(height>maxHeight){
                width *=maxHeight / height;
                height = maxHeight;
            }
            canvas.width = width;
            canvas.height = height;
            const context = canvas.getContext("2d");
            context.drawImage(img, 0, 0, width, height);
            const compressedData = canvas.toDataURL("image/jpeg",quality);
            callback(compressedData);
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(file);
}

form.addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const mobile = document.getElementById("mobile").value;
    const dob = document.getElementById("dob").value;
    const yoj = document.getElementById("yoj").value;
    const salary = document.getElementById("salary").value.trim();
    const profileFile = document.getElementById("profile").files[0];
    
    if (!validateForm(name, email, mobile, dob, yoj, salary, profileFile)) return;

    const reader = new FileReader();
    let employees = getEmployees() 
    if (profileFile) {
    compressImage(profileFile, 200, 200, 0.6, function(compressedBase64) {

        const empData = {
            profile: compressedBase64, 
            name,
            email,
            mobile,
            dob,
            yoj,
            salary
        }; 
        if (editIndex === null) {
            employees.push(empData);
        } else {
            employees[editIndex] = empData;
        }

        saveEmployees(employees);
        resetForm();
        clearImagePreview();
    });
}
else {
    const existingImage = employees[editIndex].profile;

    const empData = {
        profile: existingImage, 
        name,
        email,
        mobile,
        dob,
        yoj,
        salary
    };

    employees[editIndex] = empData;

    saveEmployees(employees);
    resetForm();
    clearImagePreview();
}
});

    </script>
</body>
</html>
